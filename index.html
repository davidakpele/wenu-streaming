<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Live Streaming</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <!-- Login/Register Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>Live Streaming</h1>
            <p id="authSubtitle">Sign in to start or join a stream</p>
            
            <div id="loginError" class="error-message"></div>
            <div id="registerSuccess" class="success-message"></div>
            
            <!-- Login Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                
                <button type="submit" class="primary" style="width: 100%;" id="loginBtn">
                    Sign In
                </button>
                
                <p style="text-align: center; margin-top: 15px; color: #999; font-size: 14px;">
                    Don't have an account? <a href="#" id="showRegisterLink" style="color: #ff0000; text-decoration: none;">Sign Up</a>
                </p>
            </form>
            
            <!-- Registration Form -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" name="email" required autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" name="username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="regFirstName">First Name</label>
                    <input type="text" id="regFirstName" name="firstName" required autocomplete="given-name">
                </div>
                
                <div class="form-group">
                    <label for="regLastName">Last Name</label>
                    <input type="text" id="regLastName" name="lastName" required autocomplete="family-name">
                </div>
                
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" name="password" required autocomplete="new-password">
                </div>
                
                <div class="form-group">
                    <label for="regConfirmPassword">Confirm Password</label>
                    <input type="password" id="regConfirmPassword" name="confirmPassword" required autocomplete="new-password">
                </div>
                
                <button type="submit" class="primary" style="width: 100%;" id="registerBtn">
                    Sign Up
                </button>
                
                <p style="text-align: center; margin-top: 15px; color: #999; font-size: 14px;">
                    Already have an account? <a href="#" id="showLoginLink" style="color: #ff0000; text-decoration: none;">Sign In</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="container">
        <div class="header">
            <div class="header-left">
                <div>
                    <h1>Live Streaming</h1>
                    <span id="streamStatus" class="status offline">Offline</span>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <div class="user-name" id="userFullName">User</div>
                        <div class="user-username" id="userUsername">@username</div>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button id="startStreamBtn" class="primary">Start Stream</button>
                <button id="joinStreamBtn" class="secondary">Join Stream</button>
                <button id="startMediaBtn" class="secondary" disabled>Start Camera/Mic</button>
                <button id="toggleAudioBtn" class="secondary" disabled>Mute Audio</button>
                <button id="toggleVideoBtn" class="secondary" disabled>Stop Video</button>
                <button id="leaveBtn" class="secondary" disabled>Leave</button>
                <button id="endStreamBtn" class="primary" disabled>End Stream</button>
                <button id="logoutBtn" class="secondary">Logout</button>
            </div>
        </div>

        <div class="stats">
            <h3 style="margin-bottom: 10px;">Stream Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="viewerCount">0</div>
                    <div class="stat-label">Viewers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="participantCount">0</div>
                    <div class="stat-label">Participants</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="streamDuration">00:00</div>
                    <div class="stat-label">Duration</div>
                </div>
            </div>
        </div>

        <div class="video-container">
            <div class="video-wrapper">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="video-label">You (Local)</div>
            </div>
            <div id="remoteVideos"></div>
        </div>

        <div class="participants">
            <h3>Participants</h3>
            <div id="participantList" class="participant-list"></div>
        </div>

        <div class="chat-container">
            <h3 style="margin-bottom: 10px;">Chat</h3>
            <div id="messages" class="messages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type a message..." disabled>
                <button id="sendMessageBtn" class="primary" disabled>Send</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="./js/streaming-client.js"></script>
    <script>
        // Configuration - UPDATE THESE VALUES
        const API_URL = 'https://wemu.onrender.com';
        const LOGIN_ENDPOINT = '/api/Auth/login';
        const REGISTER_ENDPOINT = '/api/Auth/register';
        
        // User session
        let currentUser = null;
        let accessToken = null;
        
        // Streaming client
        let client;
        let currentRoomId = null;
        let isHost = false;
        let streamStartTime = null;
        let durationInterval = null;
        let audioProducerId = null;
        let videoProducerId = null;
        let audioEnabled = true;
        let videoEnabled = true;

        // DOM elements - Auth
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const authSubtitle = document.getElementById('authSubtitle');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginError = document.getElementById('loginError');
        const registerSuccess = document.getElementById('registerSuccess');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const showRegisterLink = document.getElementById('showRegisterLink');
        const showLoginLink = document.getElementById('showLoginLink');
        
        // Login inputs
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        // Register inputs
        const regEmailInput = document.getElementById('regEmail');
        const regUsernameInput = document.getElementById('regUsername');
        const regFirstNameInput = document.getElementById('regFirstName');
        const regLastNameInput = document.getElementById('regLastName');
        const regPasswordInput = document.getElementById('regPassword');
        const regConfirmPasswordInput = document.getElementById('regConfirmPassword');

        // DOM elements - App
        const userAvatar = document.getElementById('userAvatar');
        const userFullName = document.getElementById('userFullName');
        const userUsername = document.getElementById('userUsername');
        const startStreamBtn = document.getElementById('startStreamBtn');
        const joinStreamBtn = document.getElementById('joinStreamBtn');
        const startMediaBtn = document.getElementById('startMediaBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const endStreamBtn = document.getElementById('endStreamBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const localVideo = document.getElementById('localVideo');
        const remoteVideos = document.getElementById('remoteVideos');
        const messages = document.getElementById('messages');
        const streamStatus = document.getElementById('streamStatus');
        const viewerCount = document.getElementById('viewerCount');
        const participantCount = document.getElementById('participantCount');
        const streamDuration = document.getElementById('streamDuration');
        const participantList = document.getElementById('participantList');

        // Toggle between login and register forms
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            authSubtitle.textContent = 'Create an account to get started';
            hideLoginError();
            hideRegisterSuccess();
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            authSubtitle.textContent = 'Sign in to start or join a stream';
            hideLoginError();
            hideRegisterSuccess();
        });

        // Login handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            
            if (!username || !password) {
                showLoginError('Please enter both username and password');
                return;
            }
            
            await login(username, password);
        });

        // Registration handler
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = regEmailInput.value.trim();
            const username = regUsernameInput.value.trim();
            const firstName = regFirstNameInput.value.trim();
            const lastName = regLastNameInput.value.trim();
            const password = regPasswordInput.value;
            const confirmPassword = regConfirmPasswordInput.value;
            
            if (!email || !username || !firstName || !lastName || !password || !confirmPassword) {
                showLoginError('Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showLoginError('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showLoginError('Password must be at least 6 characters');
                return;
            }
            
            await register(email, username, firstName, lastName, password);
        });

        async function register(email, username, firstName, lastName, password) {
            try {
                registerBtn.disabled = true;
                registerBtn.textContent = 'Creating Account...';
                hideLoginError();
                hideRegisterSuccess();
                
                const response = await fetch(`${API_URL}${REGISTER_ENDPOINT}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        username: username,
                        firstName: firstName,
                        lastName: lastName,
                        password: password
                    })
                });
                
                const result = await response.json();

                if (!response.ok || !result?.id) {
                    throw new Error('Registration failed');
                }

                // Show success message
                showRegisterSuccess('Account created successfully! Please sign in.');
                
                // Clear form
                registerForm.reset();
                
                // Switch to login form after 2 seconds
                setTimeout(() => {
                    registerForm.style.display = 'none';
                    loginForm.style.display = 'block';
                    authSubtitle.textContent = 'Sign in to start or join a stream';
                    hideRegisterSuccess();
                }, 2000);
                
            } catch (error) {
                console.error('Registration error:', error);
                showLoginError(error.message || 'Failed to create account. Please try again.');
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Sign Up';
            }
        }

        async function login(username, password) {
            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Signing in...';
                hideLoginError();
                
                const response = await fetch(`${API_URL}${LOGIN_ENDPOINT}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userName: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Login failed');
                }
                
                currentUser = {
                    id: result.data.id,
                    username: result.data.userName,
                    firstName: result.data.firstName,
                    lastName: result.data.lastName
                };
                accessToken = result.data.token;
                
                localStorage.setItem('user', JSON.stringify(currentUser));
                localStorage.setItem('token', accessToken);
                
                await initializeApp();
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginError(error.message || 'Failed to login. Please try again.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function showLoginError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        function hideLoginError() {
            loginError.style.display = 'none';
        }

        function showRegisterSuccess(message) {
            registerSuccess.textContent = message;
            registerSuccess.style.display = 'block';
        }

        function hideRegisterSuccess() {
            registerSuccess.style.display = 'none';
        }

        async function initializeApp() {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            
            const initials = (currentUser.firstName[0] + currentUser.lastName[0]).toUpperCase();
            userAvatar.textContent = initials;
            userFullName.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            userUsername.textContent = `@${currentUser.username}`;
            
            await initStreamingClient();
        }

        async function initStreamingClient() {
            client = new StreamingClient(API_URL, accessToken);
            
            client.onStreamStarted = handleStreamStarted;
            client.onJoinedStream = handleJoinedStream;
            client.onUserJoined = handleUserJoined;
            client.onUserLeft = handleUserLeft;
            client.onMessageReceived = handleMessageReceived;
            client.onStreamEnded = handleStreamEnded;
            client.onRemoteStream = handleRemoteStream;
            client.onProducerPaused = handleProducerPaused;
            client.onProducerResumed = handleProducerResumed;
            client.onProducerClosed = handleProducerClosed;
            client.onNewProducer = handleNewProducer;

            try {
                await client.connect();
                console.log('Connected to streaming hub');
            } catch (error) {
                console.error('Failed to connect:', error);
                alert('Failed to connect to streaming service. Please try again.');
            }
        }

        function handleStreamStarted(data) {
            currentRoomId = data.data.stream.roomid;
            isHost = true;
            streamStartTime = new Date(data.data.status.start_time);
            updateStreamStatus('live');
            updateButtons();
            startDurationTimer();
            addSystemMessage(`Stream started: ${data.data.stream.title}`);
        }

        function handleJoinedStream(data) {
            currentRoomId = data.data.stream.roomid;
            client.currentRoomId = currentRoomId;
            streamStartTime = new Date(data.data.status.start_time);
            updateStreamStatus('live');
            updateButtons();
            startDurationTimer();
            
            viewerCount.textContent = data.data.status.current_viewers;
            participantCount.textContent = data.data.participants.total_members;
            updateParticipantList(data.data.participants.users_list);
            
            console.log('Joined stream, existing producers:', data.data.existing_producers);
        }

        function handleUserJoined(data) {
            viewerCount.textContent = data.current_viewers;
            participantCount.textContent = data.total_members;
            updateParticipantList(data.participants);
            addSystemMessage(data.message);
        }

        function handleUserLeft(data) {
            viewerCount.textContent = data.current_viewers;
            participantCount.textContent = data.total_members;
            updateParticipantList(data.participants);
            addSystemMessage(data.message);
        }

        function handleMessageReceived(data) {
            if (data.type === 'system') {
                addSystemMessage(data.content);
            } else {
                addMessage(data.sender.username, data.content, data.timestamp);
            }
        }

        function handleStreamEnded(data) {
            addSystemMessage(data.message);
            cleanup();
        }

        function handleRemoteStream(stream, producerUserId, kind) {
            console.log('handleRemoteStream called:', { producerUserId, kind, stream });
            
            let videoElement = document.getElementById(`remote-${producerUserId}`);
            
            if (!videoElement) {
                videoElement = document.createElement('video');
                videoElement.id = `remote-${producerUserId}`;
                videoElement.autoplay = true;
                videoElement.playsinline = true;
                videoElement.setAttribute('playsinline', '');
                videoElement.setAttribute('webkit-playsinline', '');
                
                const wrapper = document.createElement('div');
                wrapper.className = 'video-wrapper';
                wrapper.id = `wrapper-${producerUserId}`;
                
                const label = document.createElement('div');
                label.className = 'video-label';
                label.textContent = `Remote Stream`;
                
                wrapper.appendChild(videoElement);
                wrapper.appendChild(label);
                remoteVideos.appendChild(wrapper);
                
                console.log('Created new video element for producer', producerUserId);
            }
            
            if (!videoElement.srcObject) {
                videoElement.srcObject = stream;
                videoElement.play().catch(err => {
                    console.error('Error playing video:', err);
                });
                console.log('Set stream on video element');
            } else {
                console.log('Video element already has stream');
            }
            
            stream.getTracks().forEach(track => {
                console.log(`Stream has ${track.kind} track:`, track.id, 'enabled:', track.enabled, 'muted:', track.muted);
            });
        }

        function handleProducerPaused(data) {
            addSystemMessage(`${data.kind} paused`);
        }

        function handleProducerResumed(data) {
            addSystemMessage(`${data.kind} resumed`);
        }

        function handleProducerClosed(data) {
            const wrapper = document.getElementById(`wrapper-${data.producerId}`);
            if (wrapper) wrapper.remove();
        }

        function handleNewProducer(data) {
            console.log('New producer detected:', data);
            if (client && client.currentRoomId) {
                client.consumeMedia(client.currentRoomId, data.producerId);
            }
        }

        // Button handlers
        startStreamBtn.onclick = async () => {
            const title = prompt('Stream title:', 'My Live Stream');
            if (!title) return;
            
            const description = prompt('Description:', 'Live streaming session');
            await client.startStream(currentUser.username, currentUser.id, title, description, 'General', 'public', 'video');
        };

        joinStreamBtn.onclick = async () => {
            const roomId = prompt('Enter Room ID:');
            if (!roomId) return;
            await client.joinStream(roomId, currentUser.id, currentUser.username);
        };

        startMediaBtn.onclick = async () => {
            try {
                const localStream = await client.startProducing(currentRoomId, { video: true, audio: true });
                localVideo.srcObject = localStream;
                
                const producers = Array.from(client.producers.entries());
                audioProducerId = producers.find(([id, kind]) => kind === 'audio')?.[0];
                videoProducerId = producers.find(([id, kind]) => kind === 'video')?.[0];
                
                updateButtons();
            } catch (err) {
                alert('Failed to start media: ' + err.message);
            }
        };

        toggleAudioBtn.onclick = async () => {
            if (audioProducerId) {
                if (audioEnabled) {
                    await client.pauseProducer(currentRoomId, audioProducerId);
                    toggleAudioBtn.textContent = 'Unmute Audio';
                } else {
                    await client.resumeProducer(currentRoomId, audioProducerId);
                    toggleAudioBtn.textContent = 'Mute Audio';
                }
                audioEnabled = !audioEnabled;
            }
        };

        toggleVideoBtn.onclick = async () => {
            if (videoProducerId) {
                if (videoEnabled) {
                    await client.pauseProducer(currentRoomId, videoProducerId);
                    toggleVideoBtn.textContent = 'Start Video';
                } else {
                    await client.resumeProducer(currentRoomId, videoProducerId);
                    toggleVideoBtn.textContent = 'Stop Video';
                }
                videoEnabled = !videoEnabled;
            }
        };

        leaveBtn.onclick = async () => {
            if (confirm('Are you sure you want to leave?')) {
                await client.leaveStream(currentRoomId);
                cleanup();
            }
        };

        endStreamBtn.onclick = async () => {
            if (confirm('Are you sure you want to end the stream?')) {
                await client.endStream(currentRoomId);
                cleanup();
            }
        };

        logoutBtn.onclick = () => {
            if (currentRoomId && !confirm('You are currently in a stream. Are you sure you want to logout?')) {
                return;
            }
            logout();
        };

        sendMessageBtn.onclick = async () => {
            const message = messageInput.value.trim();
            if (message) {
                await client.sendMessage(currentRoomId, message);
                messageInput.value = '';
            }
        };

        messageInput.onkeypress = (e) => {
            if (e.key === 'Enter') sendMessageBtn.click();
        };

        function logout() {
            if (currentRoomId && client) {
                client.leaveStream(currentRoomId).catch(console.error);
            }
            
            if (client) client.disconnect();
            
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            currentUser = null;
            accessToken = null;
            
            cleanup();
            appContainer.style.display = 'none';
            loginContainer.style.display = 'flex';
            loginForm.reset();
            registerForm.reset();
        }

        function updateStreamStatus(status) {
            if (status === 'live') {
                streamStatus.textContent = 'LIVE';
                streamStatus.className = 'status live';
            } else {
                streamStatus.textContent = 'Offline';
                streamStatus.className = 'status offline';
            }
        }

        function updateButtons() {
            const inStream = currentRoomId !== null;
            const hasMedia = client && client.producers.size > 0;
            
            startStreamBtn.disabled = inStream;
            joinStreamBtn.disabled = inStream;
            startMediaBtn.disabled = !inStream || hasMedia || !isHost;
            toggleAudioBtn.disabled = !hasMedia;
            toggleVideoBtn.disabled = !hasMedia;
            leaveBtn.disabled = !inStream;
            endStreamBtn.disabled = !inStream || !isHost;
            messageInput.disabled = !inStream;
            sendMessageBtn.disabled = !inStream;
        }

        function addMessage(sender, content, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            const time = new Date(timestamp).toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="message-sender">${escapeHtml(sender)}</div>
                <div class="message-content">${escapeHtml(content)}</div>
                <div class="message-time">${time}</div>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function addSystemMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateParticipantList(participants) {
            participantList.innerHTML = '';
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.innerHTML = `
                    <span class="participant-name">${escapeHtml(p.username)}</span>
                    <span class="role-badge ${p.role}">${p.role}</span>
                `;
                participantList.appendChild(div);
            });
        }

        function startDurationTimer() {
            if (durationInterval) clearInterval(durationInterval);
            
            durationInterval = setInterval(() => {
                if (streamStartTime) {
                    const elapsed = Math.floor((Date.now() - streamStartTime.getTime()) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    streamDuration.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function cleanup() {
            currentRoomId = null;
            isHost = false;
            streamStartTime = null;
            audioProducerId = null;
            videoProducerId = null;
            audioEnabled = true;
            videoEnabled = true;
            
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
            
            localVideo.srcObject = null;
            remoteVideos.innerHTML = '';
            participantList.innerHTML = '';
            viewerCount.textContent = '0';
            participantCount.textContent = '0';
            streamDuration.textContent = '00:00';
            
            updateStreamStatus('offline');
            updateButtons();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check for existing session
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('user');
            const savedToken = localStorage.getItem('token');
            
            if (savedUser && savedToken) {
                try {
                    currentUser = JSON.parse(savedUser);
                    accessToken = savedToken;
                    initializeApp();
                } catch (error) {
                    console.error('Failed to restore session:', error);
                    localStorage.removeItem('user');
                    localStorage.removeItem('token');
                }
            }
        });
    </script>
</body>
</html>